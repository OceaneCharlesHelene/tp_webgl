<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - geometry - cube</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link type="text/css" rel="stylesheet" href="main.css">
				<style>
			#blocker {
				position: absolute;
				width: 100%;
				height: 100%;
				background-color: rgba(0,0,0,0.5);
			}

			#instructions {
				width: 100%;
				height: 100%;

				display: -webkit-box;
				display: -moz-box;
				display: box;

				-webkit-box-orient: horizontal;
				-moz-box-orient: horizontal;
				box-orient: horizontal;

				-webkit-box-pack: center;
				-moz-box-pack: center;
				box-pack: center;

				-webkit-box-align: center;
				-moz-box-align: center;
				box-align: center;

				color: #ffffff;
				text-align: center;
				font-family: Arial;
				font-size: 14px;
				line-height: 24px;

				cursor: pointer;
			}
		</style>
	</head>
	<body>
		<div id="blocker">

			<div id="instructions">
				<span style="font-size:36px">Click to play</span>
				<br /><br />
				Move: WASD<br/>
				Jump: SPACE<br/>
				Look: MOUSE
			</div>

		</div>


		<script type="module">

			import * as THREE from '../build/three.module.js';
			import { OrbitControls } from './jsm/controls/OrbitControls.js';
			import { GUI } from './jsm/libs/dat.gui.module.js';
			import Stats from './jsm/libs/stats.module.js';
			import { FBXLoader } from './jsm/loaders/FBXLoader.js';



			let camera, scene, renderer;
			let caisse1;
			let caisse2;
			let colonne1;
			let caisse3;
			let caisse4;
			let colonne2;
			let caisse1_2;
			let caisse2_2;
			let colonne1_2;
			let caisse3_2;
			let caisse4_2;
			let colonne2_2;
			let caisse1_3;
			let caisse2_3;
			let colonne1_3;
			let caisse3_3;
			let caisse4_3;
			let colonne2_3;
			let caisse1_4;
			let caisse2_4;
			let colonne1_4;
			let caisse3_4;
			let caisse4_4;
			let colonne2_4;
			let plafond;
			let plateforme;
			let cube;
			let cube2;
			let cube3;
			let cube4;
			let spotLight, lightHelper, shadowCameraHelper;
			var sphere5;
			var gui;
			let material_sphere;

			const tab_pillier=[

				{x:-200,z:0},
				{x:400,z:0},
				{x:-200,z:200},
				{x:400,z:200},
				{x:-200,z:400},
				{x:400,z:400},
				{x:-200,z:-200},
				{x:400,z:-200},
				

			];


			const tab_step= [
				{y:-325,z:150},
				{y:-350,z:200},
				{y:-375,z:250},
				{y:-400,z:300},
				{y:-425,z:350},
				{y:-325,z:50},
				{y:-350,z:0},
				{y:-375,z:-50},
				{y:-375,z:100},
				{y:-400,z:-100},
				{y:-425,z:-150},

			];

			const clock = new THREE.Clock();

			let mixer;
			let mixer2;
			let stats, container;


			init();

			render();
			
			animate();

			function pillier(scene,material,geometry,geometry3,x,z){
				scene.add(caisse(geometry,material,x,-250,z))
				scene.add(caisse(geometry,material,x,250,z))
				scene.add(colonne(geometry3,material,x,0,z))	
			}


			function caisse(geometry, material,x,y,z,castShadow=true) {

				//1caisse

				caisse1 = new THREE.Mesh( geometry, material );
				caisse1.position.y = y;
				caisse1.position.x = x;
				caisse1.position.z = z;
				caisse1.castShadow = castShadow;

				return caisse1
			}

			function colonne(geometry3, material,x,y,z=0,castShadow=true) {
				
				// Colonne 
				
				const colonne1 = new THREE.Mesh( geometry3, material );
				colonne1.position.y = y;
				colonne1.position.x = x;
				colonne1.position.z = z;
				colonne1.castShadow = castShadow;

				return colonne1
				
			}

			function step(geometry_cube,material,x,y,z,castShadow=true,receiveShadow=true) {
     
                const cube = new THREE.Mesh( geometry_cube, material );
                cube.position.y = y;
                cube.position.x = x;
                cube.position.z = z;
                cube.castShadow = castShadow;
                cube.receiveShadow = receiveShadow;
                
                return cube
			}


			function init() {

				container = document.createElement( 'div' );
				document.body.appendChild( container );

				//Les personnages animés

			    const loader = new FBXLoader();
			    loader.load('models/fbx/Dancing_ninja.fbx', function (object){

					mixer = new THREE.AnimationMixer( object );
					//mixer.position.x = 14;

					const action = mixer.clipAction( object.animations[ 0 ] );
					action.play();

					object.traverse( function ( child ) {

						if ( child.isMesh ) {

							child.castShadow = true;
							child.receiveShadow = true;

						}

					} );
					
					object.position.y = -250;
					object.castShadow=true;

					scene.add( object );

				} );

				const loader2 = new FBXLoader();
			    loader2.load('models/fbx/twistDance.fbx', function (object2){

					mixer2 = new THREE.AnimationMixer( object2 );
					//mixer.position.x = 14;

					const action2 = mixer2.clipAction( object2.animations[ 0 ] );
					action2.play();

					object2.traverse( function ( child2 ) {

						if ( child2.isMesh ) {

							child2.castShadow = true;
							child2.receiveShadow = true;

						}

					} );
					
					object2.position.y = 310;
					object2.position.x = 20;
					object2.castShadow=true;

					scene.add( object2 );

				} );

				//Les renderer

				renderer = new THREE.WebGLRenderer();
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.body.appendChild( renderer.domElement );

				renderer.shadowMap.enabled = true;

				renderer.shadowMap.type = THREE.PCFSoftShadowMap;
				renderer.outputEncoding = THREE.sRGBEncoding;

				camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, 6000 );
				camera.position.z = 2000;

				scene = new THREE.Scene();

				const controls = new OrbitControls( camera, renderer.domElement );
    			controls.enableZoom = true;

    			//AJOUT DES LUMIERES 

    			// la lumière ambiante

                const ambient = new THREE.AmbientLight( 0xffffff, 0.1 );
				scene.add( ambient );

				//La source de lumière

                spotLight = new THREE.SpotLight( 0xffffff, 1 );
				spotLight.position.set( 100,600,1200);
				spotLight.angle = Math.PI / 4;
				spotLight.penumbra = 0.1;
				spotLight.decay = 2;
				spotLight.distance = 4000;

				spotLight.castShadow = true;
				spotLight.shadow.mapSize.width = 512;
				spotLight.shadow.mapSize.height = 512;
				spotLight.shadow.camera.near = 100;
				spotLight.shadow.camera.far = 200;
				spotLight.shadow.focus = 1;
				scene.add( spotLight );


				// les aides 

				//lightHelper = new THREE.SpotLightHelper( spotLight );
				//scene.add( lightHelper );

				//shadowCameraHelper = new THREE.CameraHelper( spotLight.shadow.camera );
				//scene.add( shadowCameraHelper ); 

				 //MUSIQUE DE FOND DE LA SCENE 

				// Création d'un audio
            	var listener = new THREE.AudioListener();
            	camera.add( listener );

            	// Création de la position de l'audio
            	var sound = new THREE.PositionalAudio( listener );

            	// Lancement de l'audio
            	var audioLoader = new THREE.AudioLoader();
            	audioLoader.load( 'sounds/song_twice.mp3', function( buffer ) {
                sound.setBuffer( buffer );
                sound.setLoop(true);
                sound.setVolume(3); 
                sound.play();
            	});

	            //Objet qui recoit l'audio
	            const sphere_s = new THREE.SphereGeometry( 20, 32, 16 );
	            const material_s = new THREE.MeshPhongMaterial( { color: 0x969996 } );
	            const mesh_s = new THREE.Mesh( sphere_s, material_s );
	            scene.add( mesh_s );

	            // Ajouter le son dans l'object
	            mesh_s.add( sound );

	            //Création des textures

				const texture = new THREE.TextureLoader().load( 'textures/marbre_clair.jpg' );
				const texture_sol = new THREE.TextureLoader().load( 'textures/sol.jpg' );
				const texture_sphere = new THREE.TextureLoader().load( 'textures/planets/earth_atmos_2048.jpg' );

				const geometry = new THREE.BoxBufferGeometry( 160, 30, 160);
				const material = new  THREE.MeshPhongMaterial( { map: texture, dithering: true} );
				const material_sol = new  THREE.MeshPhongMaterial( { map:texture_sol, dithering: true } );
				material_sphere = new  THREE.MeshStandardMaterial( { map: texture_sphere, roughness: 0, metalness: 0 } );

					//pillier

				const geometry3 = new THREE.CylinderBufferGeometry( 50, 50, 500, 50 );

				for (let i=0;i<tab_pillier.length;i++){

					pillier(scene,material,geometry,geometry3,tab_pillier[i].x,tab_pillier[i].z);
				}

				//Escalier

				const geometry_cube = new THREE.BoxBufferGeometry( 800,25, 800);

				for (let i=0;i<tab_step.length;i++){

					scene.add(step(geometry_cube,material,100,tab_step[i].y,tab_step[i].z));
				}

				//Plafond
				const geometry_plafond = new THREE.BoxBufferGeometry( 840, 50, 800);
				const plafond = new THREE.Mesh( geometry_plafond, material );
				plafond.position.y = 290;
				plafond.position.x = 100;
				plafond.position.z = 100;
				plafond.castShadow = true;
                plafond.receiveShadow = true;
				scene.add( plafond );

				//Plateforme
                const geometry_plateforme = new THREE.BoxBufferGeometry( 800, 200, 800);
                const plateforme = new THREE.Mesh( geometry_plateforme, material );
                plateforme.position.y = -350;
                plateforme.position.x = 100;
                plateforme.position.z = 100;
                plateforme.castShadow = true;
                plateforme.receiveShadow = true;
                scene.add( plateforme );


                //Sol

                const geometry_sol = new THREE.BoxBufferGeometry(2000,1,2000);
				const plane = new THREE.Mesh( geometry_sol, material_sol );
				plane.position.y = -450;
				plane.receiveShadow = true;
				scene.add( plane );

				//Poutre en dehors

				//1ère caisse
				let caisse1_5 = new THREE.Mesh( geometry, material );
				caisse1_5.position.y = -430;
				caisse1_5.position.x = -600;
				caisse1_5.position.z = -300;
				caisse1_5.castShadow = true;
				scene.add( caisse1_5 );


				// 2eme caisse en bois
				let caisse2_5 = new THREE.Mesh( geometry, material );
				caisse2_5.position.y = 550;
				caisse2_5.position.x = -600;
				caisse2_5.position.z = -300;
				caisse2_5.castShadow = true;
				scene.add( caisse2_5 );

				// Colonne 
				const geometry4 = new THREE.CylinderBufferGeometry( 80, 80, 1000, 50 );
				const colonne1_5 = new THREE.Mesh( geometry4, material );
				colonne1_5.position.y = 50;
				colonne1_5.position.x = -600;
				colonne1_5.position.z = -300;
				colonne1_5.castShadow = true;
				scene.add( colonne1_5 );

				//Poutre en dehors2

				//1ère caisse
				let caisse3_5 = new THREE.Mesh( geometry, material );
				caisse3_5.position.y = -430;
				caisse3_5.position.x = -600;
				caisse3_5.position.z = 500;
				caisse3_5.castShadow = true;
				scene.add( caisse3_5 );50


				// 2eme caisse en bois
				let caisse4_5 = new THREE.Mesh( geometry, material );
				caisse4_5.position.y = 550;
				caisse4_5.position.x = -600;
				caisse4_5.position.z = 500;
				caisse4_5.castShadow = true;
				scene.add( caisse4_5 );

				// Colonne 
				const colonne2_5 = new THREE.Mesh( geometry4, material );
				colonne2_5.position.y = 50;
				colonne2_5.position.x = -600;
				colonne2_5.position.z = 500;
				colonne2_5.castShadow = true;
				scene.add( colonne2_5 );

				//Poutre en dehors3

				//1ère caisse
				let caisse5_5 = new THREE.Mesh( geometry, material );
				caisse5_5.position.y = -430;
				caisse5_5.position.x = 800;
				caisse5_5.position.z = 500;
				caisse5_5.castShadow = true;
				scene.add( caisse5_5 );


				// 2eme caisse en bois
				let caisse6_5 = new THREE.Mesh( geometry, material );
				caisse6_5.position.y = 550;
				caisse6_5.position.x = 800;
				caisse6_5.position.z = 500;
				caisse6_5.castShadow = true;
				scene.add( caisse6_5 );

				// Colonne 
				const colonne3_5 = new THREE.Mesh( geometry4, material );
				colonne3_5.position.y = 50;
				colonne3_5.position.x = 800;
				colonne3_5.position.z = 500;
				colonne3_5.castShadow = true;
				scene.add( colonne3_5 );

				//Poutre en dehors4

				//1ère caisse
				let caisse7_5 = new THREE.Mesh( geometry, material );
				caisse7_5.position.y = -430;
				caisse7_5.position.x = 800;
				caisse7_5.position.z = -300;
				caisse7_5.castShadow = true;
				scene.add( caisse7_5 );


				// 2eme caisse en bois
				let caisse8_5 = new THREE.Mesh( geometry, material );
				caisse8_5.position.y = 550;
				caisse8_5.position.x = 800;
				caisse8_5.position.z = -300;
				caisse8_5.castShadow = true;
				scene.add( caisse8_5 );

				// Colonne 
				const colonne4_5 = new THREE.Mesh( geometry4, material );
				colonne4_5.position.y = 50;
				colonne4_5.position.x = 800;
				colonne4_5.position.z = -300;
				colonne4_5.castShadow = true;
				scene.add( colonne4_5 );

				//sphere 
				 const geometry_sphere = new THREE.SphereGeometry(100, 50, 50 );
                const sphere = new THREE.Mesh( geometry_sphere, material );
                sphere.position.y = 625;
                sphere.position.x = -600;
                sphere.position.z = -300;

                sphere.castShadow = true;
                scene.add(sphere);


				//sphere2 
                const sphere2 = new THREE.Mesh( geometry_sphere, material );
                sphere2.position.y = 625;
                sphere2.position.x = -600;
                sphere2.position.z = 500;
                sphere2.castShadow = true;
                scene.add(sphere2);

				//sphere 3
                var sphere3 = new THREE.Mesh( geometry_sphere, material );
                sphere3.position.y = 625;
                sphere3.position.x = 800;
                sphere3.position.z = 500;
                sphere3.castShadow = true;
                scene.add(sphere3);

				//sphere 4
                const sphere4 = new THREE.Mesh( geometry_sphere, material );
                sphere4.position.y = 625;
                sphere4.position.x = 800;
                sphere4.position.z = -300;
                sphere4.castShadow = true;
                scene.add(sphere4);


                // Sphère du milieu 
				 const geometry_sphere_centre = new THREE.SphereGeometry(200, 100, 100 );
                sphere5 = new THREE.Mesh( geometry_sphere_centre, material_sphere); 
                sphere5.position.y = 1000;
                sphere5.position.x = 100;
                sphere5.position.z = 100;
                sphere5.castShadow = true;
                scene.add(sphere5);

				// performance monitor

				stats = new Stats();
				container.appendChild( stats.dom );

    			render();

				window.addEventListener( 'resize', onWindowResize, false );

			}

			// les fonctions

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function animate() {

				requestAnimationFrame( animate );
				sphere5.rotation.x += 0.1;
				sphere5.rotation.y += 0.1;

				const delta = clock.getDelta();

				if ( mixer ) mixer.update( delta );

				renderer.render( scene, camera );
				stats.update();

			}

			function render() {

				//lightHelper.update();

				//shadowCameraHelper.update();

				renderer.render( scene, camera );

			}

			function buildGui() {

				gui = new GUI();
				let param = {
					'roughness': material_sphere.roughness,
					'metalness': material_sphere.metalness
};

			const standardFolder = gui.addFolder( 'Standard Material' );

				standardFolder.add( param, 'roughness', 0.0, 1.0 ).step( 0.01 ).onChange( function ( val ) {

					material_sphere.roughness = val;


				} );

				standardFolder.add( param, 'metalness', 0.0, 1.0 ).step( 0.01 ).onChange( function ( val ) {

					material_sphere.metalness = val;


				} );

				standardFolder.open();

}

				buildGui();

		</script>

	</body>
</html>
